{{#partial "page"}}
<section class="page pages-custom-retail-submission-form">
    {{{region name="page_builder_content"}}}

    <div>
        {{#replace '%%Syndicate%%' page.content}}
        {{> components/page/rss_feed}}
        {{else}}
        <p>{{{page.content}}}</p>
        {{/replace}}
    </div>
    <div class="container">
        <div class="content login">

            <div class="select-date">
                <h2 class="header-title">Select Date & Time</h2>
                <div class="date-container">
                    <div> <input class="inline-picker" type="hidden" id="inline-picker"
                            placeholder="Select Date & Time"></div>
                    <div class="time">

                        <button class="date-button">10:00 AM</button>
                        <button class="date-button">10:30 AM</button>
                        <button class="date-button active">11:00 AM</button>
                        <button class="date-button">11:30 AM</button>
                        <button class="date-button">12:00 PM</button>
                        <button class="date-button">12:30 PM</button>
                        <button class="date-button">1:00 PM</button>
                        <button class="date-button">1:30 PM</button>
                        <button class="date-button">2:00 PM</button>
                        <button class="date-button">2:30 PM</button>
                        <button class="date-button">3:00 PM</button>
                        <button class="date-button">3:30 PM</button>
                    </div>
                </div>

            </div>
            <form id="retail-finder-form" class="form">
                <h2 class="header-title">{{lang 'request_appointment.title'}}</h2>
                <div class="form-retail-row">
                    <div class="form-field filter">
                        <span class="form-label">{{lang 'request_appointment.firstName'}} <span class="asterisk">*</span></span>
    
                        <input required class="form-input" type="text" name="firstName" oninvalid="this.setCustomValidity('THIS FIELD IS REQUIRED'); this.setCustomValidity.style.background='#000'" onchange="try{setCustomValidity('')}catch(e){};"
                            placeholder="{{lang 'request_appointment.firstName'}}">
    
                    </div>
                    <div class=" form-field filter">
                        <span class="form-label">{{lang 'request_appointment.lastName'}} <span class="asterisk">*</span></span>
    
                        <input required class="form-input" type="text" name="lastName"
                            placeholder="{{lang 'request_appointment.lastName'}}">
    
                    </div>
                </div>
                <div class="form-retail-row">
                    <!--Add Email-->
                        <div class="form-field filter">
                            <span class="form-label">{{lang 'request_appointment.email'}} <span class="asterisk">*</span></span>

                            <input required class="form-input" type="email" name="email"
                                placeholder="{{lang 'request_appointment.email'}}"/>

                        </div>
                    <div class="form-field filter">
                        <span class="form-label">{{lang 'request_appointment.phone'}} <span class="asterisk">*</span></span>

                        <input id="phone" required class="form-input" type="tel" minlength="10" name="phoneNumber"
                            placeholder="{{lang 'request_appointment.phone'}}"/>

                    </div>
                </div>
                
                <div class="checkbox-fields">
                    <!-- <div class="checkbox-field">

                        <label for="register_pass-news"> <input type="checkbox" name="smsAlerts"
                                class="register_pass-news">
                            {{lang 'request_appointment.smsAlerts'}}
                        </label>
                    </div> -->
                    <div class="checkbox-field">

                        <label for="register_pass-news"> <input type="checkbox" name="emailAlerts"
                                class="register_pass-news"> {{lang 'request_appointment.emailAlerts'}}</label>
                    </div>

                </div>
                <div class="disclaimer">
                    <span>SAMPLE TEXT</span> - Message and data rates may apply. Max 5 msgs/mo. Consent not required to
                    buy
                    goods/svcs. Terms and conditions at ourwebsite.com/terms. Privacy policy at Ourwebsite.com/privacy.
                </div>
                <div class="form-field filter">
                    <span class="form-label">{{lang 'request_appointment.address1'}} <span class="asterisk">*</span></span>

                    <input id="address1" class="form-input" type="text" name="address1"
                        placeholder="{{lang 'request_appointment.address1'}}">

                </div>
                <div class="form-field filter">
                    <span class="form-label">{{lang 'request_appointment.address2'}}</span>

                    <input id="address2" class="form-input" type="text" name="address2"
                        placeholder="{{lang 'request_appointment.address2'}}">

                </div>
                <div class="city-container">
                    <div class="form-field filter">
                        <span class="form-label">{{lang 'request_appointment.city'}} <span class="asterisk">*</span></span>

                        <input id="city" class="form-input" type="text" name="city"
                            placeholder="{{lang 'request_appointment.city'}}">

                    </div>
                    <div class="form-field filter">

                        <span class="form-label">{{lang 'request_appointment.state'}} <span class="asterisk">*</span></span>
                        <select id="state" name="state" class="form-select selector-dropdown">
                            <option hidden value="">Select one</option>
                            <option value="AL">AL</option>
                            <option value="AK">AK</option>
                            <option value="AZ">AZ</option>
                            <option value="AR">AR</option>
                            <option value="CA">CA</option>
                            <option value="CO">CO</option>
                            <option value="CT">CT</option>
                            <option value="DE">DE</option>
                            <option value="FL">FL</option>
                            <option value="GA">GA</option>
                            <option value="HI">HI</option>
                            <option value="ID">ID</option>
                            <option value="IL">IL</option>
                            <option value="IN">IN</option>
                            <option value="IA">IA</option>
                            <option value="KS">KS</option>
                            <option value="KY">KY</option>
                            <option value="LA">LA</option>
                            <option value="ME">ME</option>
                            <option value="MD">MD</option>
                            <option value="MA">MA</option>
                            <option value="MI">MI</option>
                            <option value="MN">MN</option>
                            <option value="MS">MS</option>
                            <option value="MO">MO</option>
                            <option value="MT">MT</option>
                            <option value="NE">NE</option>
                            <option value="NV">NV</option>
                            <option value="NH">NH</option>
                            <option value="NJ">NJ</option>
                            <option value="NM">NM</option>
                            <option value="NY">NY</option>
                            <option value="NC">NC</option>
                            <option value="ND">ND</option>
                            <option value="OH">OH</option>
                            <option value="OK">OK</option>
                            <option value="OR">OR</option>
                            <option value="PA">PA</option>
                            <option value="RI">RI</option>
                            <option value="SC">SC</option>
                            <option value="SD">SD</option>
                            <option value="TN">TN</option>
                            <option value="TX">TX</option>
                            <option value="UT">UT</option>
                            <option value="VT">VT</option>
                            <option value="VA">VA</option>
                            <option value="WA">WA</option>
                            <option value="WV">WV</option>
                            <option value="WI">WI</option>
                            <option value="WY">WY</option>
                        </select>

                    </div>
                    <div class="form-field filter">
                        <span class="form-label">{{lang 'request_appointment.zip'}} <span class="asterisk">*</span></span>

                        <input id="zip" maxlength="5" class="form-input" type="text" name="zip"
                            placeholder="{{lang 'request_appointment.zip'}}" onkeyup="this.value=this.value.replace(/[a-zA-Z]/,'');">

                    </div>
                </div>
                <div class="form-retail-row">
                    <div class="form-field filter flatpickr">
                        <span class="form-label">{{lang 'request_appointment.preferedAppointment'}} <span class="asterisk">*</span></span>

                        <input required class="form-input multiple-dates " name="preferredDates" type="text"
                            placeholder="MM/DD/YYYY">
                        <div class="disclaimer">Selected dates are not guarenteed.</div>
                    </div>
                    <div class="form-field filter">
                        <span class="form-label">{{lang 'request_appointment.peopleAttending'}} <span class="asterisk">*</span></span>
    
                        <input class="form-input" type="number" min="1" name="noOfPeopleAttending"
                            placeholder="{{lang 'request_appointment.peopleAttending'}}" onkeyup="this.value=this.value.replace(/[$&+,:;=?[\]@#|{}'<>.^*()%!-/]/,'');">
    
                    </div>
                </div>

               
                <div class="form-retail-row">
                    <div id="eventDate" class="form-field filter flatpickr">
                        <span class="form-label">{{lang 'request_appointment.eventDate'}} <span class="asterisk">*</span></span>

                        <input required name="eventDate" class="form-input date-picker " type="text"
                            placeholder="MM/DD/YYYY">

                    </div>
                </div>
                <div class="checkbox-fields">
                    <div class="checkbox-field">

                        <label for="register_pass-news"> <input name="termsAndCond" type="checkbox"
                                class="register_pass-news">{{lang 'request_appointment.agreeTerms'}}*</label>
                    </div>


                </div>

                <button class="button" type="submit">Submit</button>

            </form>
            <div id="thank-you">
                <h2 class="header-title">Thank you for requesting an appointment!</h2>
                <p><span>We'll will be in touch with you soon.</span></p>
                <p><a href="/" class="button" type="button">Continue Shopping</a></p>
            </div>

        </div>
    </div>

</section>
<script>
    let autocomplete;
    let address1Field;
    let address2Field;
    let postalField;
    function initAutocomplete() {
        address1Field = document.querySelector("#address1");
        address2Field = document.querySelector("#address2");
        postalField = document.querySelector("#zip");
        // Create the autocomplete object, restricting the search predictions to
        // addresses in the US and Canada.
        autocomplete = new google.maps.places.Autocomplete(address1Field, {
            componentRestrictions: { country: ["us", "ca"] },
            fields: ["address_components", "geometry"],
            types: ["address"],
        });
        address1Field.focus();
        // When the user selects an address from the drop-down, populate the
        // address fields in the form.
        autocomplete.addListener("place_changed", fillInAddress);
    }
    function fillInAddress() {
        // Get the place details from the autocomplete object.
        const place = autocomplete.getPlace();
        let address1 = "";
        let postcode = "";

        // Get each component of the address from the place details,
        // and then fill-in the corresponding field on the form.
        // place.address_components are google.maps.GeocoderAddressComponent objects
        // which are documented at http://goo.gle/3l5i5Mr
        for (const component of place.address_components) {
            // @ts-ignore remove once typings fixed
            const componentType = component.types[0];

            switch (componentType) {
                case "street_number": {
                    address1 = `${component.long_name} ${address1}`;
                    break;
                }

                case "route": {
                    address1 += component.short_name;
                    break;
                }

                case "postal_code": {
                    postcode = `${component.long_name}${postcode}`;
                    break;
                }


                case "locality":
                    document.querySelector("#city").value = component.long_name;
                    break;
                case "administrative_area_level_1": {
                    document.querySelector("#state").value = component.short_name;
                    break;
                }
                case "country":
                    //document.querySelector("#country").value = component.long_name;
                    break;
            }
        }

        address1Field.value = address1;
        postalField.value = postcode;
        // After filling the form with address components from the Autocomplete
        // prediction, set cursor focus on the second address line to encourage
        // entry of subpremise information such as apartment, unit, or floor number.
        address2Field.focus();
    }
    window.initAutocomplete = initAutocomplete;

    window.addEventListener("load", (event) => {
        //initalize google autocomplete
        // const addressInput = document.getElementById('');
        // const autocomplete = new google.maps.places.Autocomplete(addressInput);
        // autocomplete.addListener('place_changed', function () {
        //     const place = autocomplete.getPlace();
        //     document.getElementById('address1').value = place.address_components[0].long_name;
        //     document.getElementById('route').value = place.address_components[1].long_name;
        //     document.getElementById('locality').value = place.address_components[2].long_name;
        //     document.getElementById('administrative_area_level_1').value = place.address_components[5].short_name;
        // });
        // Initialize the date picker on load
        flatpickr('.date-picker', { position: 'below', monthSelectorType: 'static', minDate: "today" })
        flatpickr('.inline-picker', { inline: true, monthSelectorType: 'static', minDate: "today" })
        flatpickr('.multiple-dates', {
            monthSelectorType: 'static', minDate: "today",
            mode: 'multiple', position: 'below', onChange: function (selectedDates, dateStr, instance) {
                var selectedDatesStr = selectedDates.reduce(function (acc, ele) {
                    var str = instance.formatDate(ele, "d/m/Y");
                    acc = (acc == '') ? str : acc + ';' + str;
                    return acc;
                }, '');
                instance.set('enable', [function (date) {
                    if (selectedDates.length >= 3) {
                        var currDateStr = instance.formatDate(date, "d/m/Y")
                        var x = selectedDatesStr.indexOf(currDateStr);
                        return x != -1;
                    } else {
                        return true;
                    }
                }]);
            }
        });
        //Initialize Inputmask 
        Inputmask({ "mask": "(999) 999-9999" }).mask(document.getElementById("phone"));

        const form = document.getElementById('retail-finder-form');
        form.addEventListener('submit', (event) => {
            event.preventDefault(); // prevent the form from being submitted

            // get the form values
            const firstName = form.elements.firstName.value;
            const lastName = form.elements.lastName.value;
            const email = form.elements.email.value;

            const phone = form.elements.phoneNumber.value;
            //const phoneType = form.elements.phoneType.value;
            // const smsAlerts = form.elements.smsAlerts.checked;
            const emailAlerts = form.elements.emailAlerts.checked;
            const terms = form.elements.termsAndCond.checked;
            const address1 = form.elements.address1.value;
            const address2 = form.elements.address2.value;
            const city = form.elements.city.value;
            const state = form.elements.state.value;
            const zip = form.elements.zip.value;
            const eventDate = form.elements.eventDate.value;
            //strip out time value from event date, date format being YYYY-MM-DD HH:MM
            // const eventDateOnly = eventDate.split(' ')[0];
            // const eventTime = eventDate.split(' ')[1];
            const noOfPeopleAttending = form.elements.noOfPeopleAttending.value;
            const preferredDates = form.elements.preferredDates.value;
            //get retailer name from querystring
            const retailerName = new URLSearchParams(window.location.search).get('retailerName');
            //get retailer id from querystring
            const retailerId = new URLSearchParams(window.location.search).get('retailerId');



            //get unmasked phone number
            var unmaskedPhone = Inputmask.unmask(phone, { "mask": "(999) 999-9999" });
            // validate the form values
            if (!firstName || !lastName || !email || !phone || unmaskedPhone.length < 10 || !address1 || !city || !state || !zip || !eventDate || !noOfPeopleAttending || !preferredDates) {
                // show an error message if any of the required fields are empty
                alert('Please fill out all the required fields.');
                return;
            }

            if (!terms) {
                // show an error message if the "I Agree" checkbox is not checked
                alert('You must agree to the terms and conditions to continue.');
                return;
            }

            // submit the form using fetch
            const url = 'https://apim.workato.com/allure/allure-b2c-website/retailer/appointmentrequest' // get the form action url
            const method = 'POST' // get the form method (POST, GET, etc.)
            //Generate form data
            const formData = {
                FirstName: firstName,
                LastName: lastName,
                Email: email,
                PhoneNumber: '+1' + unmaskedPhone,
                Address1: address1,
                Address2: address2,
                City: city,
                State: state,
                PostalCode: zip,
                AppointmentDate: eventDate,
                NumberPeopleinAppointment: parseInt(noOfPeopleAttending),
                EmailOptin: emailAlerts,
                RetailerName: retailerName,
                RetailerId: retailerId ? parseInt(retailerId) : 0,
                DirectBook: "true",
                PreferredAppointmentDates: preferredDates
            };

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'API-TOKEN': 'c0bce025e1792e283cfbd229321ecc423ae60257cf462c8d262d7b10fd9e41f9'
                },
                body: JSON.stringify(formData),
            })
                .then((response) => {
                    // do something with the response
                    console.log(response);
                    //hide form section and show thank you section
                    document.getElementById('retail-finder-form').style.display = 'none';
                    document.getElementById('thank-you').style.display = 'block';
                    //Go to top of page
                    window.scrollTo(0, 0);

                })
                .catch((error) => {
                    // handle any errors
                    console.error(error);
                });
        });

        document.getElementById("retail-finder-form").addEventListener('invalid', (function(){
            return function(e) {
                //prevent the browser from showing default error bubble / hint
                e.preventDefault();
                var errorDiv = document.createElement("span");
                errorDiv.classList.add("error-message");
                errorDiv.innerText = "This Field is required";

                insertAfter(errorDiv,  e.target);

                function insertAfter(newNode, existingNode) {
                    existingNode.parentNode.insertBefore(newNode, existingNode.nextSibling);
                }
            };
        })(), true);

    });

</script>
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA68nj5mHdkdbHs0O6JOVfzYoau2oeD-Gs&callback=initAutocomplete&libraries=places">
    </script>
{{/partial}}

{{> layout/base}}